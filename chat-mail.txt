Voici **le message complet, clair et structurÃ©** que tu peux **copier-coller directement Ã  Claude**.
Il regroupe TOUT ce que tu veux quâ€™il comprenne :

* synchronicitÃ© bulle â†” chat
* IMAP
* crÃ©ation automatique de templates email
* tool manquant
* prochaine mission
* ce quâ€™il doit prÃ©parer en architecture
* ce quâ€™il doit vÃ©rifier

Câ€™est la **version parfaite**, sans bruit, sans ambiguÃ¯tÃ©.

---

# ğŸ§  **ğŸ”µ Message complet Ã  envoyer Ã  Claude**

Claude, voilÃ  ce que je veux que tu intÃ¨gres maintenant dans lâ€™architecture de MAX, en une seule vision cohÃ©rente :

---

# ğŸŒ **1. SynchronicitÃ© totale â€” une seule mÃ©moire pour la bulle et le chat**

Je veux que **la bulle MAX dans EspoCRM**
et **lâ€™espace chat MAX**
soient deux interfaces diffÃ©rentes,
mais quâ€™ils partagent **une seule mÃ©moire rÃ©elle**, basÃ©e sur le CRM.

### ğŸ”¹ RÃ¨gles obligatoires

1. **Toute action que MAX exÃ©cute dans la bulle** (suggestion acceptÃ©e, enrichissement, diagnostic, prochaine action, etc.)
   â†’ doit crÃ©er une entrÃ©e **MissionMAX** avec :

   * `leadId`
   * `type`
   * `contenu`
   * `etat` (proposÃ©, appliquÃ©, refusÃ©)
   * `timestamp`

2. Quand je reparle Ã  MAX dans **le chat**, il doit **relire** :

   * le Lead (API Espo)
   * les MissionMAX associÃ©es
   * les DiagnosticIA associÃ©s
     â†’ **pas** son historique de conversation.
     â†’ Lâ€™historique CRM = unique source de vÃ©ritÃ©.

3. Le chat doit Ãªtre capable de dire :

   > â€œVoici ce que jâ€™ai fait rÃ©cemment pour ce lead.â€
   > â†’ en lisant MissionMAX, jamais en devinant.

4. La bulle = interface contextuelle
   Le chat = interface globale
   â†’ mais **mÃªme cerveau**, mÃªme mÃ©moire.

---

# ğŸ“§ **2. IMAP â€” vÃ©rification & intÃ©gration**

Tu dois vÃ©rifier et prÃ©parer :

1. **Est-ce que lâ€™IMAP est configurÃ© dans EspoCRM ?**
   (ParamÃ¨tres email â†’ IMAP â†’ connexion valide ?)

2. Si oui :
   M.A.X. doit pouvoir lire :

   * emails reÃ§us liÃ©s au lead (par adresse email)
   * historiques de communication
   * et utiliser cette info dans son diagnostic et ses suggestions.

3. Si non :
   M.A.X. doit afficher un **message clair** :

   > â€œIMAP nâ€™est pas configurÃ© dans EspoCRM, je ne peux pas lire les emails entrants.â€

---

# ğŸ§° **3. TOOL obligatoire pour M.A.X. : crÃ©ation automatique de template email dans Espo**

Tu dois ajouter un tool appelÃ© :

### **`create_email_template`**

Il doit :

* crÃ©er un enregistrement `EmailTemplate` dans Espo
* contenir :

  * `name`
  * `subject`
  * `bodyHtml`
  * `category` (â€œMaCrÃ©a COREâ€)

But :
ğŸ‘‰ Quand je demande un template dâ€™email,
MAX doit me gÃ©nÃ©rer le HTML **ET** lâ€™enregistrer dans EspoCRM automatiquement.
Sans copier-coller.

Câ€™est une brique essentielle pour la partie â€œcopilot emailâ€.

---

# ğŸ«§ **4. La BULLE MAX â€” comportement Ã  implÃ©menter**

(la prochaine grosse mission)

Quand lâ€™utilisateur clique sur la bulle en bas Ã  droite :

1. Le frontend transmet le **leadId** (rÃ©cupÃ©rÃ© via lâ€™URL de lâ€™iframe)
2. MAX doit :

   * relire le lead (API Espo)
   * relire les MissionMAX rÃ©centes
   * relire DiagnosticIA sâ€™il existe
3. MAX propose **une suggestion intelligente**, par exemple :

   * enrichissement (remplir champs)
   * tags stratÃ©giques
   * statut nurturing
   * prochaine action
   * proposition dâ€™email
4. Lâ€™utilisateur a 2 boutons :

   * â€œAccepterâ€ â†’ MAX applique (update fields + MissionMAX Ã©tat = appliquÃ©)
   * â€œRefuserâ€ â†’ rien ne change (MissionMAX Ã©tat = refusÃ©)

ğŸ’¡ La bulle nâ€™a pas besoin dâ€™Ãªtre complexe :
juste une fenÃªtre simple avec suggestions + 2 boutons.

---

# ğŸš€ **5. Ce que tu dois prÃ©parer pour la suite (architecture)**

### âœ” API â€œcontext leadâ€

Endpoint cÃ´tÃ© backend :
â†’ `/max/context`
Pour transmettre Ã  MAX lâ€™entity + id de la fiche actuelle.

### âœ” API â€œapply suggestionâ€

â†’ `/max/apply-suggestion`
Pour exÃ©cuter les tools dâ€™update Espo.

### âœ” Lecture centralisÃ©e des MissionMAX

Tool â†’ `get_missions_for_lead(leadId)`

### âœ” SÃ©paration :

* mÃ©moire mÃ©tier = CRM
* mÃ©moire discussion = chat (Ã©phÃ©mÃ¨re, non bloquante)

---

# ğŸ“Œ **En rÃ©sumÃ© pour toi, Claude :**

**Objectif gÃ©nÃ©ral :**

> â€œUne seule intelligence MAX, plusieurs interfaces.
> Tout ce que la bulle fait doit Ãªtre enregistrÃ© dans MissionMAX.
> Le chat doit relire MissionMAX, DiagnosticIA et le Lead pour rester synchro.â€

Et :

> â€œPrÃ©pare les tools IMAP, email template, et bulle MAX comme prochaine mission.â€

---

Si tu veux, je peux aussi te rÃ©diger **le prompt systÃ¨me exact** Ã  ajouter Ã  `agent_identity.json` pour activer ce comportement.
