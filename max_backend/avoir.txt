LES choses √† voir vercel :
tagsia ( si c'est pareil dans le CRM et autres )

les erreurs : Le probl√®me est que nginx est configur√© pour api.max.studiomacrea.cloud mais le frontend utilise max-api.studiomacrea.cloud. Je dois ajouter cette config.
Vercel : Le probl√®me vient du nom de projet inf√©r√©. Laissez-moi essayer avec un nom explicite. Deploiment manuel cli
Possibilit√© erreur 403 : 
Cl√© API OpenAI - invalide, quota d√©pass√©, ou facturation bloqu√©e
Authentification backend - JWT invalide ou expir√©
V√©rifiez sur votre serveur Scaleway :


# V√©rifier les logs du backend
pm2 logs max-backend --lines 50

# Ou si c'est systemd
journalctl -u max-backend -n 50
Causes probables :

Erreur	Cause	Solution
403 OpenAI	Cl√© API invalide ou quota	V√©rifier OPENAI_API_KEY dans .env
403 Auth	JWT expir√©	Se reconnecter sur le frontend
404 /chat	Route non trouv√©e	Backend pas d√©marr√© ou mauvaise URL
Pouvez-vous me donner les logs du serveur ou v√©rifier votre cl√© OpenAI sur platform.openai.com ?
Remus√© projet MAX _ cluade :

Read project MAX and summarized architecture
Je vais analyser le projet MAX (CRM) en lecture seule. Je commence par explorer la structure et les fichiers cl√©s.

Read multiple files and searched for patterns
Je vais maintenant cr√©er un r√©sum√© complet de l'architecture du projet MAX (CRM) en lecture seule.

üìä ANALYSE PROJET MAX (CRM) - R√âSUM√â
üèóÔ∏è ARCHITECTURE G√âN√âRALE
Type: CRM Intelligent Multi-Tenant avec Assistant IA
Stack: Node.js + Express (backend) | React + Vite (frontend) | EspoCRM | PostgreSQL/Supabase
Environnement: Docker (Scaleway - Production) | MariaDB | Nginx

üéØ COMPOSANTS PRINCIPAUX
1. Backend (max_backend/) - Port 3005
Serveur: Express.js modulaire (480 lignes server.js)
IA: OpenAI GPT-4o / Anthropic Claude (dual brain)
Routes: 70+ endpoints organis√©s par domaine
Actions Layer: Syst√®me unifi√© d'ex√©cution CRM
Middleware: Auth JWT, ACL, Headers multi-tenant, Consent Gate
Routes critiques:

/api/chat - Interface conversationnelle M.A.X.
/api/consent/* - Syst√®me consentement utilisateur
/api/activities/* - Logging activit√©s leads
/api/settings/* - Configuration providers (Email/SMS/WhatsApp)
/api/dashboard/* - KPIs et m√©triques
2. Frontend (max_frontend/) - Port 5173/Vercel
Framework: React 18 + Vite
State: Zustand stores
Styling: TailwindCSS
Auth: JWT avec refresh token
D√©ploiement: Vercel (https://max.studiomacrea.cloud)
3. EspoCRM - Port 8080
Version: Custom avec extensions
Database: MariaDB 10.11
API: REST v1 avec cl√© API
Extensions: MaxLayoutManager, champs customs
4. Infrastructure Docker

services:¬†¬†-¬†max-backend¬†(Node.js)¬†¬†-¬†espocrm¬†(PHP¬†+¬†Apache)¬†¬†-¬†mariadb¬†(10.11)¬†¬†-¬†nginx¬†(reverse¬†proxy)
üîê SYST√àME DE S√âCURIT√â
Multi-Tenant
Header X-Tenant pour isolation
Config par tenant dans .env
Tenants actuels: macrea (admin), damath, coach-vero, michele-care
Consent Gate ‚ö†Ô∏è POINT CRITIQUE
Fichiers:

consentGate.js - Middleware validation
consent.js - API endpoints
requestConsent.js - Action tool
Workflow:

M.A.X. anticipe op√©ration structurelle
Appelle request_consent tool AVANT ex√©cution
Frontend affiche ConsentCard avec countdown (5min)
User approuve/rejette
Backend valide consentId avant ex√©cution
Audit trail complet
Gates de validation:

GATE 1: consentId manquant ‚Üí 412 (intelligent response)
GATE 2: consentId invalide ‚Üí 404
GATE 3: d√©j√† utilis√©/rejet√© ‚Üí 409
GATE 4: expir√© (>5min) ‚Üí 410
Authentification
JWT avec JWT_SECRET
Refresh tokens
API Keys pour EspoCRM
Chiffrement credentials providers (CREDENTIALS_ENCRYPTION_KEY)
üõ†Ô∏è FONCTIONNALIT√âS CL√âS
1. Action Layer (max_backend/actions/)
Actions disponibles:

create_opportunity - Cr√©er opportunit√©s
create_contact - Cr√©er contacts
create_ticket - Cr√©er tickets support
create_knowledge_article - Articles KB
write_crm_note - Notes CRM
send_email - Envoi email (3 modes)
send_sms - SMS Twilio
send_whatsapp - WhatsApp Green-API
update_crm_field - Mise √† jour champs
modify_layout - Modification layouts EspoCRM
request_consent - Demande consentement ‚ö†Ô∏è
2. Syst√®me Email (3 Modes)
Mode 1 (Default): no-reply@malalacrea.fr + reply-to client
Mode 2 (Custom Domain): Domaine client via Mailjet MaCr√©a
Mode 3 (Self-Service): Credentials SMTP propres

Quota: 1000 emails/mois inclus | D√©passement: 0.005‚Ç¨/email

3. Communication Multi-Canal
Email: Mailjet (Mode 1-3)
SMS: Twilio (credentials chiffr√©s)
WhatsApp: Green-API (QR code instance)
4. Intelligence M.A.X.
Tools (Function Calling): 1705 lignes (maxTools.js)

Gestion leads (query, update, delete, import)
Enrichissement automatique
Segmentation intelligente
Reporting/Analytics
Gestion workflows
M√©moire contextuelle:

Fen√™tre glissante 72h
Limite 100 messages
Budget tokens configurable
‚ö†Ô∏è POINTS SENSIBLES IDENTIFI√âS
üî¥ CRITIQUES
Consent Gate - Production Ready mais nouveau

Impl√©ment√© r√©cemment (2025-12-31)
Tests E2E en cours
Workflow complexe frontend ‚Üî backend
Risque: Bypass possible si validation backend d√©sactiv√©e
Fichiers: consentGate.js, routes/consent.js, ConsentCard.tsx
Variables .env manquantes = Crash

Validation stricte au d√©marrage (server.js L8-28)
7 variables OBLIGATOIRES
Risque: D√©ploiement √©choue si .env incomplet
Chiffrement Credentials

Cl√© 32 bytes dans CREDENTIALS_ENCRYPTION_KEY
Risque: Providers inaccessibles si cl√© perdue/chang√©e
Pas de backup/recovery automatique
PHP Executor Mode

Mode LOCAL (Docker) vs SSH distant
Risque: Hardcode Windows dans anciens scripts
Nouveaux fichiers: phpExecutorDocker.js, phpExecutorAuto.js
Multi-Tenant Tenant Resolution

Header X-Tenant critique
Bug r√©cent: 'macrea-admin' ‚Üí 'macrea' (corrig√©)
Risque: Isolation tenant compromise si header absent
üü† IMPORTANTS
Supabase Database Connection

IPv6 ENETUNREACH sur certains serveurs
Solution: FORCE_IPV4=true (L142-176 server.js)
DNS resolve4 avec fallback
JWT Secret Rotation

Pas de m√©canisme rotation automatique
Invalidation tous tokens si changement
Quota Email Management

Compteur en base (email_quota_usage)
Risque: D√©passement = facturation auto (0.005‚Ç¨/email)
Pas d'alerte pr√©ventive
WhatsApp Green-API QR Code

Expiration 45s
Risque: Instance invalide si QR non scann√©
Polling frontend requis
Batch Import (10k+ leads)

Job engine asynchrone
Risque: Memory overflow si fichiers trop gros
Pas de limite hard
üü° √Ä SURVEILLER
Action Logger Performance

Log chaque action CRM en base
Risque: Table lead_activities croissance infinie
EspoCRM API Rate Limits

Pas de throttling backend
Risque: 429 Too Many Requests
Migrations SQL Non Versionn√©es

Fichiers manuels (migrations/*.sql)
Pas d'ORM (Prisma/Sequelize)
Risque: Drift schema dev/prod
Extension EspoCRM Custom

MaxLayoutManager custom
Risque: Incompatibilit√© upgrades EspoCRM
Token Budget M.A.X.

Limite configurable (TOKENS_BUDGET_TOTAL=20M)
Risque: IA arr√™t si budget √©puis√©
üì¶ D√âPENDANCES EXTERNES CRITIQUES
Services Cloud:

Supabase (PostgreSQL + Auth)
OpenAI API (GPT-4o)
Anthropic API (Claude Sonnet)
Mailjet (Email)
Twilio (SMS)
Green-API (WhatsApp)
Vercel (Frontend hosting)
Scaleway (Docker production)
Panne de l'un = Impact s√©v√®re

üöÄ √âTAT ACTUEL (2025-01-29)
‚úÖ PRODUCTION - STABLE

Backend: Scaleway Docker OK
Frontend: Vercel d√©ploy√©
Consent Gate: Impl√©ment√©, en tests
Email 3 modes: D√©ploy√©
WhatsApp: Op√©rationnel
Dashboard: Fonctionnel
‚ö†Ô∏è EN COURS

Tests E2E Consent Gate
Validation DNS domaines custom (Mode 2)
Migration tenant macrea-admin ‚Üí macrea (corrig√© frontend)
üî¥ POINTS DE VIGILANCE

Consent Gate nouveau (surveillance monitoring requis)
Multi-tenant isolation (tests penetration recommand√©s)
Quota email tracking (alertes √† configurer)
Note: Aucun fichier n'a √©t√© modifi√©. Cette analyse est en lecture seule comme demand√©.