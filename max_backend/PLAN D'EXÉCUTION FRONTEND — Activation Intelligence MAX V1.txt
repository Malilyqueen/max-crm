PLAN D'EXÉCUTION — Activation Intelligence MAX V1
1. PLAN D'EXÉCUTION DÉTAILLÉ
Phase 1 — Templates réels (Fondation)
#	Tâche	Dépendance	Risque	Fichiers impactés
1.1	Créer migration message_templates	Aucune	✅ Safe	migrations/013_message_templates.sql (nouveau)
1.2	Créer endpoint GET/POST /api/templates	1.1	✅ Safe	routes/templates.js (nouveau)
1.3	Migrer 12 templates hardcodés → DB	1.1, 1.2	✅ Safe	Script one-shot
1.4	Créer useTemplatesStore.ts	1.2	✅ Safe	stores/useTemplatesStore.ts (nouveau)
1.5	Modifier TemplatesSection.tsx	1.4	⚠️ Modéré	Suppression données hardcodées
1.6	Créer endpoint POST /api/templates/draft-from-chat	1.2	✅ Safe	routes/templates.js
1.7	Ajouter tool MAX create_template_draft	1.6	⚠️ Modéré	lib/maxTools.js
Phase 2 — Automatisations réelles
#	Tâche	Dépendance	Risque	Fichiers impactés
2.1	Créer migration automations	Aucune	✅ Safe	migrations/014_automations.sql (nouveau)
2.2	Créer endpoint GET/POST /api/automations	2.1	✅ Safe	routes/automations.js (nouveau)
2.3	Migrer 6 workflows mockés → DB	2.1, 2.2	✅ Safe	Script one-shot
2.4	Créer useAutomationsStore.ts (refactor)	2.2	⚠️ Modéré	Remplace mock par API
2.5	Modifier AutomationPage.tsx	2.4	⚠️ Modéré	Consomme store réel
Phase 3 — Intelligence MAX (relances)
#	Tâche	Dépendance	Risque	Fichiers impactés
3.1	Créer lib/maxDecisionEngine.js	Aucune	✅ Safe	Nouveau fichier
3.2	Mapper règles (silence, non-ouvert, réponse)	3.1	✅ Safe	Dans maxDecisionEngine
3.3	Endpoint GET /api/max/recommendations	3.1, 3.2	✅ Safe	routes/max-recommendations.js (nouveau)
3.4	Connecter AlertsWidget aux recommendations	3.3	⚠️ Modéré	AlertsWidget.tsx
Phase 4 — UX décisionnelle
#	Tâche	Dépendance	Risque	Fichiers impactés
4.1	Créer composant SignalsBlock.tsx	Aucune	✅ Safe	Nouveau composant
4.2	Intégrer SignalsBlock dans LeadDetail	4.1	⚠️ Modéré	LeadDetail.tsx
4.3	Améliorer Dashboard (relances, silence, chauds)	3.3	⚠️ Modéré	DashboardPage.tsx
Ordre d'exécution recommandé

PHASE 1 (Templates)     PHASE 2 (Automations)
    │                        │
    ├─ 1.1 migration         ├─ 2.1 migration
    ├─ 1.2 API               ├─ 2.2 API
    ├─ 1.3 migration data    ├─ 2.3 migration data
    ├─ 1.4 store             ├─ 2.4 store
    ├─ 1.5 frontend          ├─ 2.5 frontend
    ├─ 1.6 draft endpoint    │
    └─ 1.7 tool MAX          │
                             │
         PHASE 3 (Intelligence MAX)
              │
              ├─ 3.1 decision engine
              ├─ 3.2 règles
              ├─ 3.3 recommendations API
              └─ 3.4 AlertsWidget
                   │
              PHASE 4 (UX)
              │
              ├─ 4.1 SignalsBlock
              ├─ 4.2 LeadDetail
              └─ 4.3 Dashboard
2. CONFIRMATION ÉCRITE — Ma compréhension
Comment MAX crée un brouillon

┌─────────────────────────────────────────────────────────────┐
│ UTILISATEUR dans /chat ou /max                              │
│ "MAX, crée-moi un email de relance pour les leads froids"   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ MAX (GPT-4o) analyse la demande                             │
│ → Détecte l'intention : création de template                │
│ → Appelle le tool `create_template_draft`                   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ POST /api/templates/draft-from-chat                         │
│ Body: {                                                     │
│   channel: 'email',                                         │
│   name: 'Relance leads froids',                             │
│   subject: 'Nous pensons à vous...',                        │
│   content: '...',                                           │
│   variables: ['firstName', 'company'],                      │
│   generatedBy: 'max'                                        │
│ }                                                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Backend crée le template avec status = 'draft'              │
│ INSERT INTO message_templates (...)                         │
│ Retourne { ok: true, template_id: 'tpl_xxx' }               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ MAX répond dans le chat :                                   │
│ "✅ Brouillon créé : Template #tpl_xxx                      │
│  Tu peux le retrouver dans Pilote Automatique > Templates   │
│  ou le modifier avec : 'MAX, modifie le template #tpl_xxx'" │
└─────────────────────────────────────────────────────────────┘
Résultat : Le brouillon est visible immédiatement dans l'onglet Pilote Automatique > Modèles de Templates. L'utilisateur peut le valider (draft → active) ou demander à MAX de le modifier.

Comment un template devient automatisable

┌─────────────────────────────────────────────────────────────┐
│ Table message_templates                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ id: tpl_xxx                                             │ │
│ │ channel: email                                          │ │
│ │ name: "Relance leads froids"                            │ │
│ │ status: active  ← (validé par l'utilisateur)            │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          │ L'utilisateur ou MAX crée une automation
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Table automations                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ id: auto_yyy                                            │ │
│ │ trigger_type: 'silence'                                 │ │
│ │ trigger_config: { days: 3 }                             │ │
│ │ template_id: 'tpl_xxx'  ← LIEN                          │ │
│ │ stop_conditions: ['replied', 'status_converted']        │ │
│ │ status: 'active'                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
Lien : L'automation référence un template_id. Quand elle se déclenche, elle utilise le contenu du template pour l'envoi.

V1 : L'automation est "déclarative" — elle dit "quoi faire" mais l'exécution peut être :

Manuelle (l'utilisateur clique)
Via les alertes existantes
Via n8n (déjà connecté au backend)
Comment MAX décide de relancer

┌─────────────────────────────────────────────────────────────┐
│ maxDecisionEngine.js                                        │
│                                                             │
│ Entrée : message_events + lead_activities + alerts          │
│                                                             │
│ Règles évaluées :                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 1. SILENCE > 3 jours                                    │ │
│ │    - Dernier message sortant > 3j                       │ │
│ │    - Aucun message entrant depuis                       │ │
│ │    → Action: "Relancer par {canal préféré}"             │ │
│ │    → Raison: "Aucune réponse depuis {X} jours"          │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 2. OUVERT SANS RÉPONSE > 24h                            │ │
│ │    - Email status = 'opened'                            │ │
│ │    - Timestamp opened > 24h                             │ │
│ │    - Aucun message entrant depuis                       │ │
│ │    → Action: "Relancer (a lu mais pas répondu)"         │ │
│ │    → Raison: "Email ouvert il y a {X}h, sans suite"     │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 3. NON OUVERT > 48h                                     │ │
│ │    - Email status = 'delivered' (pas 'opened')          │ │
│ │    - Timestamp > 48h                                    │ │
│ │    → Action: "Renvoyer ou changer de canal"             │ │
│ │    → Raison: "Email non ouvert depuis {X} jours"        │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ 4. RÉPONSE REÇUE → STOP                                 │ │
│ │    - Message entrant (direction='in')                   │ │
│ │    → Action: AUCUNE (conversation active)               │ │
│ │    → Raison: "Lead a répondu, attendre suite"           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ Sortie : Liste de recommendations                           │
│ {                                                           │
│   leadId, leadName,                                         │
│   action: "Relancer par WhatsApp",                          │
│   reason: "Email délivré il y a 3 jours, non ouvert",       │
│   priority: 'high' | 'medium' | 'low',                      │
│   suggestedTemplate: 'tpl_xxx'                              │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
Source de données : Uniquement les tables existantes (message_events, lead_activities). Aucune nouvelle collecte.

Comment l'utilisateur garde le contrôle

┌─────────────────────────────────────────────────────────────┐
│ CONTRÔLE UTILISATEUR                                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 1. TEMPLATES                                                │
│    - MAX crée des BROUILLONS (status='draft')               │
│    - L'utilisateur VALIDE avant activation                  │
│    - L'utilisateur peut MODIFIER ou SUPPRIMER               │
│                                                             │
│ 2. AUTOMATIONS                                              │
│    - Toggle ON/OFF visible dans Pilote Automatique          │
│    - Conditions d'arrêt configurables                       │
│    - L'utilisateur peut DÉSACTIVER à tout moment            │
│                                                             │
│ 3. RELANCES MAX                                             │
│    - MAX PROPOSE, il n'exécute pas automatiquement          │
│    - Affichage dans Dashboard : "À relancer aujourd'hui"    │
│    - L'utilisateur CLIQUE pour déclencher                   │
│    - OU active une automation pour déléguer                 │
│                                                             │
│ 4. TRANSPARENCE                                             │
│    - Chaque action affiche le "POURQUOI"                    │
│    - Timeline lead montre tout l'historique                 │
│    - Aucune action cachée                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
3. POURQUOI CETTE IMPLÉMENTATION RESPECTE L'EXISTANT
Ce qui ne change PAS
Composant	État
Table campaigns	❌ Non modifiée
Table message_events	❌ Non modifiée
Table lead_activities	❌ Non modifiée
Endpoints /api/campaigns/*	❌ Non modifiés
Flux d'envoi bulk	❌ Non modifié
Flux de tracking webhooks	❌ Non modifié
Isolation multi-tenant	❌ Non modifiée
Ce qui est AJOUTÉ (sans casser)
Ajout	Impact sur l'existant
Table message_templates	Nouvelle table, zéro dépendance
Table automations	Nouvelle table, zéro dépendance
Endpoint /api/templates/*	Nouvelles routes, pas de conflit
Endpoint /api/automations/*	Nouvelles routes, pas de conflit
Tool MAX create_template_draft	Ajout dans maxTools.js, pas de suppression
Composant SignalsBlock	Nouveau composant, intégration optionnelle
Ce qui est MODIFIÉ (avec précaution)
Modification	Risque	Mitigation
TemplatesSection.tsx	⚠️ Modéré	Remplace données hardcodées par API, même UX
AutomationPage.tsx	⚠️ Modéré	Remplace mock par DB, même UX
useAutomationStore.ts	⚠️ Modéré	Même interface, source différente
AlertsWidget.tsx	⚠️ Modéré	Ajout de données, pas de suppression
LeadDetail.tsx	⚠️ Modéré	Ajout bloc Signaux, pas de suppression
Principe de non-corruption
Additivité : On ajoute, on ne supprime pas
Isolation : Nouvelles tables = nouvelles routes = pas d'interférence
Rétrocompatibilité : Les endpoints existants restent identiques
Fail-safe : Si les nouvelles features échouent, les anciennes fonctionnent toujours
Voici pourquoi cette implémentation respecte l'existant et ne corrompt pas le CRM :

L'architecture est additive : je crée 2 nouvelles tables (message_templates, automations) et de nouveaux endpoints sans toucher aux flux de campagnes, tracking, ou alertes existants. Les seules modifications concernent le remplacement de données hardcodées par des appels API — l'UX reste identique. MAX devient capable de créer des brouillons visibles dans le produit, mais l'utilisateur garde le contrôle total (validation, toggle on/off, conditions d'arrêt). Les décisions de relance sont proposées avec une raison explicite, jamais exécutées automatiquement sans consentement.