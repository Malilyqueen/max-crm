// 1. ğŸ“¦ Imports
import express from 'express';
import fs from 'fs';
import path from 'path';
import cors from 'cors';
import bodyParser from 'body-parser';
import { say } from './utils/say.js';
import { askOpenAI, askOpenAI_task } from './utils/ask.js';
import { savePrompt, saveTask, getLastMessages } from './utils/memory.js'; // ğŸ‘ˆ ici

// 2. ğŸ§  App
const app = express();
const PORT = 3005;

// 3. ğŸ”§ Middlewares
app.use(cors());
app.use(bodyParser.json());

// 4. ğŸ“„ Statique (ex. : project-map)
app.get('/project-map.json', (req, res) => {
  const map = fs.readFileSync('./project-map.json', 'utf8');
  res.setHeader('Content-Type', 'application/json');
  res.send(map);
});

// 5. ğŸ’¬ Route intelligente IA avec mÃ©moire
app.post('/api/ask-task', async (req, res) => {
  let prompt = req.body.prompt;

  // ğŸ§  Lire les 10 derniers messages
  const history = getLastMessages(10);
  const historyText = history.map(h => `${h.role.toUpperCase()}: ${h.content}`).join('\n');

  // ğŸ§  Injecter dans prompt final
  prompt = `Voici les derniers Ã©changes :\n${historyText}\n\nNouvelle instruction : ${prompt}`;

  const response = await askOpenAI_task(prompt);
  savePrompt('user', req.body.prompt);
  savePrompt('ai', response);
  say(response); // ğŸ—£ï¸ Voix IA
  res.send({ response });
});
